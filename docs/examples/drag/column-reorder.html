<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>e-virt-table - åˆ—æ‹–æ‹½æ’åºæ›´æ–°</title>
    </head>
    <script src="https://unpkg.com/e-virt-table/dist/index.umd.js"></script>
    <body>
        <div style="margin-bottom: 10px;">
            <strong>è¯´æ˜ï¼š</strong>æ‹–æ‹½åˆ—åä¼šé‡æ–°ç»„ç»‡åˆ—é…ç½®å¹¶æ›´æ–°è¡¨æ ¼æ˜¾ç¤ºï¼Œæ¨¡æ‹Ÿä¿å­˜ç”¨æˆ·çš„åˆ—é…ç½®åå¥½ã€‚
            <button id="reset-btn" style="margin-left: 10px;">é‡ç½®åˆ—é¡ºåº</button>
        </div>
        <div id="e-virt-table"></div>
        <div id="column-display" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
            <strong>å½“å‰åˆ—é¡ºåºï¼š</strong>
            <div id="column-content"></div>
        </div>
    </body>
    <script>
        let data = [
            {
                id: 'EMP001',
                name: 'å¼ ä¸‰',
                email: 'zhangsan@example.com',
                phone: '13800138001',
                department: 'æŠ€æœ¯éƒ¨',
                position: 'å‰ç«¯å·¥ç¨‹å¸ˆ',
                salary: 15000,
                hireDate: '2023-01-15',
                status: 'åœ¨èŒ',
            },
            {
                id: 'EMP002',
                name: 'æå››',
                email: 'lisi@example.com',
                phone: '13800138002',
                department: 'äº§å“éƒ¨',
                position: 'äº§å“ç»ç†',
                salary: 18000,
                hireDate: '2022-08-20',
                status: 'åœ¨èŒ',
            },
            {
                id: 'EMP003',
                name: 'ç‹äº”',
                email: 'wangwu@example.com',
                phone: '13800138003',
                department: 'è®¾è®¡éƒ¨',
                position: 'UIè®¾è®¡å¸ˆ',
                salary: 12000,
                hireDate: '2023-03-10',
                status: 'åœ¨èŒ',
            },
            {
                id: 'EMP004',
                name: 'èµµå…­',
                email: 'zhaoliu@example.com',
                phone: '13800138004',
                department: 'æŠ€æœ¯éƒ¨',
                position: 'åç«¯å·¥ç¨‹å¸ˆ',
                salary: 16000,
                hireDate: '2021-12-05',
                status: 'ç¦»èŒ',
            },
        ];

        // åŸå§‹åˆ—é…ç½®
        const originalColumns = [
            {
                title: 'å‘˜å·¥ID',
                key: 'id',
                width: 100,
                align: 'center',
                readonly: true,
                order: 1,
            },
            {
                title: 'å§“å',
                key: 'name',
                width: 100,
                align: 'left',
                readonly: true,
                order: 2,
            },
            {
                title: 'é‚®ç®±',
                key: 'email',
                width: 180,
                align: 'left',
                readonly: true,
                order: 3,
            },
            {
                title: 'ç”µè¯',
                key: 'phone',
                width: 120,
                align: 'center',
                readonly: true,
                order: 4,
            },
            {
                title: 'éƒ¨é—¨',
                key: 'department',
                width: 100,
                align: 'center',
                readonly: true,
                order: 5,
            },
            {
                title: 'èŒä½',
                key: 'position',
                width: 120,
                align: 'left',
                readonly: true,
                order: 6,
            },
            {
                title: 'è–ªèµ„',
                key: 'salary',
                width: 100,
                align: 'right',
                readonly: true,
                formatter: ({ value }) => `Â¥${value.toLocaleString()}`,
                order: 7,
            },
            {
                title: 'å…¥èŒæ—¥æœŸ',
                key: 'hireDate',
                width: 120,
                align: 'center',
                readonly: true,
                order: 8,
            },
            {
                title: 'çŠ¶æ€',
                key: 'status',
                width: 80,
                align: 'center',
                readonly: true,
                formatter: ({ value }) => value === 'åœ¨èŒ' ? 'ğŸŸ¢ åœ¨èŒ' : 'ğŸ”´ ç¦»èŒ',
                order: 9,
            },
        ];

        // å½“å‰åˆ—é…ç½®
        let currentColumns = [...originalColumns];

        const eVirtTable = new EVirtTable(document.getElementById('e-virt-table'), {
            columns: currentColumns,
            data,
            config: {
                BORDER: true,
                STRIPE: true,
                CELL_HEIGHT: 40,
                HEADER_HEIGHT: 40,
                ROW_KEY: 'id',
                ENABLE_DRAG_COLUMN: true,
                HIGHLIGHT_HOVER_ROW: true,
            },
        });

        // æ›´æ–°åˆ—é¡ºåºæ˜¾ç¤º
        function updateColumnDisplay() {
            const columnContent = document.getElementById('column-content');
            columnContent.innerHTML = currentColumns.map((col, index) => 
                `${index + 1}. ${col.title} (${col.key})`
            ).join('<br>');
        }

        // åˆå§‹æ˜¾ç¤º
        updateColumnDisplay();

        // é‡æ–°ç»„ç»‡åˆ—é…ç½®
        function reorganizeColumns(columns, sourceColumnKey, targetColumnKey) {
            const newColumns = [...columns];
            
            // æ‰¾åˆ°æºåˆ—çš„ç´¢å¼•
            const sourceIndex = newColumns.findIndex(col => col.key === sourceColumnKey);
            const sourceColumn = newColumns[sourceIndex];
            
            // ä»åŸä½ç½®ç§»é™¤
            newColumns.splice(sourceIndex, 1);
            
            if (targetColumnKey === null) {
                // ç§»åŠ¨åˆ°ç¬¬ä¸€ä½
                newColumns.unshift(sourceColumn);
            } else {
                // æ‰¾åˆ°ç›®æ ‡ä½ç½®
                const targetIndex = newColumns.findIndex(col => col.key === targetColumnKey);
                // æ’å…¥åˆ°ç›®æ ‡ä½ç½®ä¹‹å
                newColumns.splice(targetIndex + 1, 0, sourceColumn);
            }
            
            // é‡æ–°åˆ†é…order
            newColumns.forEach((col, index) => {
                col.order = index + 1;
            });
            
            return newColumns;
        }

        // ç›‘å¬åˆ—æ‹–æ‹½äº‹ä»¶
        eVirtTable.on('columnMove', (eventData) => {
            const { source, target, sourceColumnKey, targetColumnKey } = eventData;
            
            console.log('åˆ—æ‹–æ‹½äº‹ä»¶:', eventData);
            
            // é‡æ–°ç»„ç»‡åˆ—é…ç½®
            currentColumns = reorganizeColumns(currentColumns, sourceColumnKey, targetColumnKey);
            
            // æ›´æ–°è¡¨æ ¼åˆ—é…ç½®
            eVirtTable.loadColumns(currentColumns);
            
            // æ›´æ–°æ˜¾ç¤º
            updateColumnDisplay();
            
            // æ¨¡æ‹Ÿä¿å­˜ç”¨æˆ·çš„åˆ—é…ç½®åå¥½åˆ°localStorage
            const columnPreference = currentColumns.map(col => ({
                key: col.key,
                order: col.order
            }));
            localStorage.setItem('userColumnPreference', JSON.stringify(columnPreference));
            console.log('ä¿å­˜åˆ—é…ç½®åå¥½:', columnPreference);
        });

        // é‡ç½®æŒ‰é’®åŠŸèƒ½
        document.getElementById('reset-btn').addEventListener('click', () => {
            currentColumns = [...originalColumns];
            eVirtTable.loadColumns(currentColumns);
            updateColumnDisplay();
            localStorage.removeItem('userColumnPreference');
            console.log('é‡ç½®åˆ—é¡ºåº');
        });

        // é¡µé¢åŠ è½½æ—¶å°è¯•æ¢å¤ç”¨æˆ·çš„åˆ—é…ç½®åå¥½
        function loadColumnPreference() {
            const saved = localStorage.getItem('userColumnPreference');
            if (saved) {
                try {
                    const preference = JSON.parse(saved);
                    const orderedColumns = [...originalColumns].sort((a, b) => {
                        const aOrder = preference.find(p => p.key === a.key)?.order || a.order;
                        const bOrder = preference.find(p => p.key === b.key)?.order || b.order;
                        return aOrder - bOrder;
                    });
                    
                    currentColumns = orderedColumns;
                    eVirtTable.loadColumns(currentColumns);
                    updateColumnDisplay();
                    console.log('æ¢å¤ç”¨æˆ·åˆ—é…ç½®åå¥½');
                } catch (e) {
                    console.warn('æ¢å¤åˆ—é…ç½®åå¥½å¤±è´¥:', e);
                }
            }
        }

        // åŠ è½½ä¿å­˜çš„é…ç½®
        loadColumnPreference();
    </script>
</html>
