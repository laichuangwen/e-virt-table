<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>e-virt-table - æ ‘å½¢æ•°æ®è¡Œæ‹–æ‹½</title>
    </head>
    <script src="https://unpkg.com/e-virt-table/dist/index.umd.js"></script>
    <body>
        <div style="margin-bottom: 10px;">
            <strong>è¯´æ˜ï¼š</strong>æ”¯æŒæ ‘å½¢ç»“æ„çš„è¡Œæ‹–æ‹½ï¼Œå¯ä»¥æ”¹å˜èŠ‚ç‚¹çš„å±‚çº§å…³ç³»å’Œæ’åºã€‚
        </div>
        <div id="e-virt-table"></div>
        <div id="tree-display" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
            <strong>å½“å‰æ ‘å½¢ç»“æ„ï¼š</strong>
            <div id="tree-content"></div>
        </div>
    </body>
    <script>
        let data = [
            {
                id: 1,
                name: 'å‰ç«¯å¼€å‘',
                type: 'éƒ¨é—¨',
                manager: 'å¼ æ€»ç›‘',
                members: 8,
                budget: 500000,
                children: [
                    {
                        id: 2,
                        name: 'Reactå›¢é˜Ÿ',
                        type: 'å›¢é˜Ÿ',
                        manager: 'æç»„é•¿',
                        members: 4,
                        budget: 250000,
                        children: [
                            {
                                id: 3,
                                name: 'ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ',
                                type: 'é¡¹ç›®',
                                manager: 'ç‹å·¥ç¨‹å¸ˆ',
                                members: 2,
                                budget: 120000,
                            },
                            {
                                id: 4,
                                name: 'è®¢å•ç®¡ç†ç³»ç»Ÿ',
                                type: 'é¡¹ç›®',
                                manager: 'èµµå·¥ç¨‹å¸ˆ',
                                members: 2,
                                budget: 130000,
                            },
                        ],
                    },
                    {
                        id: 5,
                        name: 'Vueå›¢é˜Ÿ',
                        type: 'å›¢é˜Ÿ',
                        manager: 'é’±ç»„é•¿',
                        members: 4,
                        budget: 250000,
                        children: [
                            {
                                id: 6,
                                name: 'ç§»åŠ¨ç«¯åº”ç”¨',
                                type: 'é¡¹ç›®',
                                manager: 'å­™å·¥ç¨‹å¸ˆ',
                                members: 2,
                                budget: 120000,
                            },
                            {
                                id: 7,
                                name: 'ç®¡ç†åå°',
                                type: 'é¡¹ç›®',
                                manager: 'å‘¨å·¥ç¨‹å¸ˆ',
                                members: 2,
                                budget: 130000,
                            },
                        ],
                    },
                ],
            },
            {
                id: 8,
                name: 'åç«¯å¼€å‘',
                type: 'éƒ¨é—¨',
                manager: 'åˆ˜æ€»ç›‘',
                members: 6,
                budget: 400000,
                children: [
                    {
                        id: 9,
                        name: 'Javaå›¢é˜Ÿ',
                        type: 'å›¢é˜Ÿ',
                        manager: 'å´ç»„é•¿',
                        members: 3,
                        budget: 200000,
                        children: [
                            {
                                id: 10,
                                name: 'ç”¨æˆ·æœåŠ¡',
                                type: 'é¡¹ç›®',
                                manager: 'éƒ‘å·¥ç¨‹å¸ˆ',
                                members: 1,
                                budget: 80000,
                            },
                            {
                                id: 11,
                                name: 'è®¢å•æœåŠ¡',
                                type: 'é¡¹ç›®',
                                manager: 'é™ˆå·¥ç¨‹å¸ˆ',
                                members: 2,
                                budget: 120000,
                            },
                        ],
                    },
                    {
                        id: 12,
                        name: 'Pythonå›¢é˜Ÿ',
                        type: 'å›¢é˜Ÿ',
                        manager: 'ä½•ç»„é•¿',
                        members: 3,
                        budget: 200000,
                        children: [
                            {
                                id: 13,
                                name: 'æ•°æ®åˆ†æå¹³å°',
                                type: 'é¡¹ç›®',
                                manager: 'å†¯å·¥ç¨‹å¸ˆ',
                                members: 2,
                                budget: 150000,
                            },
                        ],
                    },
                ],
            },
        ];

        let columns = [
            {
                title: 'åç§°',
                key: 'name',
                width: 200,
                align: 'left',
                readonly: true,
                type: 'tree',
            },
            {
                title: 'ç±»å‹',
                key: 'type',
                width: 100,
                align: 'center',
                readonly: true,
                formatter: ({ value }) => {
                    const typeMap = {
                        'éƒ¨é—¨': 'ğŸ¢ éƒ¨é—¨',
                        'å›¢é˜Ÿ': 'ğŸ‘¥ å›¢é˜Ÿ',
                        'é¡¹ç›®': 'ğŸ“‹ é¡¹ç›®',
                    };
                    return typeMap[value] || value;
                },
            },
            {
                title: 'è´Ÿè´£äºº',
                key: 'manager',
                width: 120,
                align: 'center',
                readonly: true,
            },
            {
                title: 'äººå‘˜æ•°é‡',
                key: 'members',
                width: 100,
                align: 'center',
                readonly: true,
                formatter: ({ value }) => `${value}äºº`,
            },
            {
                title: 'é¢„ç®—',
                key: 'budget',
                width: 120,
                align: 'right',
                readonly: true,
                formatter: ({ value }) => `Â¥${(value / 10000).toFixed(1)}ä¸‡`,
            },
        ];

        const eVirtTable = new EVirtTable(document.getElementById('e-virt-table'), {
            columns,
            data,
            config: {
                BORDER: true,
                STRIPE: true,
                CELL_HEIGHT: 40,
                HEADER_HEIGHT: 40,
                ROW_KEY: 'id',
                ENABLE_DRAG_ROW: true,
                HIGHLIGHT_HOVER_ROW: true,
                TREE_EXPAND_ALL: true,
                TREE_INDENT: 20,
            },
        });

        // æ˜¾ç¤ºæ ‘å½¢ç»“æ„
        function displayTreeStructure(data, level = 0) {
            let result = '';
            data.forEach(item => {
                const indent = 'ã€€'.repeat(level);
                result += `${indent}${item.name} (${item.type})<br>`;
                if (item.children && item.children.length > 0) {
                    result += displayTreeStructure(item.children, level + 1);
                }
            });
            return result;
        }

        function updateTreeDisplay() {
            const treeContent = document.getElementById('tree-content');
            const currentData = eVirtTable.getData();
            treeContent.innerHTML = displayTreeStructure(currentData);
        }

        // åˆå§‹æ˜¾ç¤º
        updateTreeDisplay();

        // é‡å»ºæ ‘å½¢ç»“æ„
        function rebuildTreeStructure(flatData) {
            // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ ‘å½¢ç»“æ„é‡å»ºå‡½æ•°
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡é€»è¾‘æ¥å®ç°
            
            // åˆ›å»ºèŠ‚ç‚¹æ˜ å°„
            const nodeMap = new Map();
            flatData.forEach(item => {
                nodeMap.set(item.id, { ...item, children: [] });
            });

            // é‡å»ºçˆ¶å­å…³ç³»
            const rootNodes = [];
            flatData.forEach(item => {
                const node = nodeMap.get(item.id);
                if (item.parentId && nodeMap.has(item.parentId)) {
                    const parent = nodeMap.get(item.parentId);
                    parent.children.push(node);
                } else {
                    rootNodes.push(node);
                }
            });

            return rootNodes;
        }

        // å±•å¹³æ ‘å½¢æ•°æ®ä»¥ä¾¿é‡æ–°æ’åº
        function flattenTreeData(data, parentId = null, level = 0) {
            let result = [];
            data.forEach(item => {
                const flatItem = { 
                    ...item, 
                    parentId: parentId,
                    level: level,
                    children: undefined // ç§»é™¤childrenä»¥é¿å…å¾ªç¯å¼•ç”¨
                };
                result.push(flatItem);
                
                if (item.children && item.children.length > 0) {
                    result = result.concat(flattenTreeData(item.children, item.id, level + 1));
                }
            });
            return result;
        }

        // ç›‘å¬è¡Œæ‹–æ‹½äº‹ä»¶
        eVirtTable.on('rowMove', (eventData) => {
            const { source, target, sourceRowKey, targetRowKey } = eventData;
            
            console.log('æ ‘å½¢è¡Œæ‹–æ‹½äº‹ä»¶:', eventData);
            
            // è·å–å½“å‰æ•°æ®
            const currentData = eVirtTable.getData();
            
            // å±•å¹³æ•°æ®
            const flatData = flattenTreeData(currentData);
            
            // é‡æ–°æ’åº
            const sourceIndex = flatData.findIndex(item => item.id == sourceRowKey);
            const sourceItem = flatData[sourceIndex];
            
            // ä»åŸä½ç½®ç§»é™¤
            flatData.splice(sourceIndex, 1);
            
            if (targetRowKey === null) {
                // ç§»åŠ¨åˆ°ç¬¬ä¸€ä½ï¼Œæˆä¸ºæ ¹èŠ‚ç‚¹
                sourceItem.parentId = null;
                sourceItem.level = 0;
                flatData.unshift(sourceItem);
            } else {
                // æ‰¾åˆ°ç›®æ ‡ä½ç½®
                const targetIndex = flatData.findIndex(item => item.id == targetRowKey);
                const targetItem = flatData[targetIndex];
                
                // è®¾ç½®ä¸ºç›®æ ‡é¡¹çš„åŒçº§ï¼Œæ’å…¥åˆ°ç›®æ ‡é¡¹ä¹‹å
                sourceItem.parentId = targetItem.parentId;
                sourceItem.level = targetItem.level;
                flatData.splice(targetIndex + 1, 0, sourceItem);
            }
            
            // é‡å»ºæ ‘å½¢ç»“æ„
            const newTreeData = rebuildTreeStructure(flatData);
            
            // æ›´æ–°è¡¨æ ¼æ•°æ®
            eVirtTable.loadData(newTreeData);
            
            // æ›´æ–°æ˜¾ç¤º
            updateTreeDisplay();
            
            console.log('é‡æ–°ç»„ç»‡åçš„æ ‘å½¢ç»“æ„:', newTreeData);
        });
    </script>
</html>
